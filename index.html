<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Expense Manager</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* CSS Variables */
        :root {
            --primary-color: #4f46e5;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --income-color: #10b981;
            --expense-color: #ef4444;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --primary-color: #6366f1;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --input-bg: #374151;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        body { background-color: var(--bg-color); color: var(--text-color); min-height: 100vh; overflow-x: hidden; }

        /* Navbar */
        .navbar {
            background-color: var(--card-bg); padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; width: 100%;
        }
        .brand { color: var(--primary-color); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .theme-toggle { cursor: pointer; font-size: 1.1rem; padding: 5px; }
        
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 20px; transition: 0.2s; }
        .user-profile:hover { background-color: var(--bg-color); }
        .user-profile img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--primary-color); object-fit: cover; }
        .user-name { font-size: 0.85rem; font-weight: 600; color: var(--text-color); display: block; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute; top: 65px; right: 5%; width: 290px; background: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 20px; display: none; flex-direction: column; gap: 10px; z-index: 1001;
        }
        .profile-dropdown.active { display: flex; }
        .dropdown-form label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px; display: block; }
        .dropdown-form input { width: 100%; padding: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); border-radius: 6px; font-size: 0.9rem; margin-bottom: 10px; }
        input[type="file"] { font-size: 0.8rem; padding: 5px; }
        .save-btn { background: var(--primary-color); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 500; }
        .logout-btn { background: transparent; color: var(--expense-color); border: 1px solid var(--expense-color); padding: 8px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 5px; }

        /* Container */
        .container { padding: 20px; max-width: 1100px; margin: 0 auto; width: 100%; }

        /* Buttons */
        .action-bar { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; color: white; }
        .btn-reset { background: var(--expense-color); }
        .btn-pdf { background: #3b82f6; }
        .btn-img { background: #8b5cf6; }

        /* Cards */
        .balance-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border-color); }
        .card h3 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .card h1 { font-size: 1.4rem; font-weight: 600; }
        .money.plus { color: var(--income-color); }
        .money.minus { color: var(--expense-color); }

        /* Limit */
        .limit-section { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .progress-container { width: 100%; background: var(--border-color); border-radius: 10px; height: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.5s; background: var(--income-color); }
        .limit-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start; }
        .form-container { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); position: sticky; top: 90px; z-index: 10; }
        .form-control { margin-bottom: 12px; }
        .form-control label { display: block; margin-bottom: 4px; font-size: 0.85rem; font-weight: 500; }
        .form-control input, .form-control select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-color); font-size: 0.9rem; }
        .btn { width: 100%; padding: 10px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; }
        
        /* Right Col */
        .right-column { display: flex; flex-direction: column; gap: 20px; width: 100%; overflow: hidden; }
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .chart-card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); height: 320px; display: flex; flex-direction: column; align-items: center; position: relative; min-width: 0; overflow: hidden; }
        .chart-card h4 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .canvas-wrapper { position: relative; width: 100%; height: 100%; }

        /* History */
        .history-list { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .list { list-style: none; max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .list li {
            background: var(--bg-color); color: var(--text-color); display: flex; justify-content: space-between;
            align-items: center; padding: 8px 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid transparent; font-size: 0.85rem;
        }
        .list li.plus { border-left-color: var(--income-color); }
        .list li.minus { border-left-color: var(--expense-color); }
        
        /* --- CUSTOM DELETE BUTTON CSS --- */
        .delete-btn { 
            background: none; 
            border: none; 
            padding: 0; 
            cursor: pointer; 
            opacity: 0.7; 
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
        }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }
        .delete-btn img {
            width: 28px; /* Icon Size */
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .form-container { position: static; order: 1; }
            .right-column { order: 2; }
        }
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .balance-container { grid-template-columns: 1fr; gap: 10px; }
            .charts-row { grid-template-columns: 1fr; }
            .chart-card { height: 320px; width: 100%; }
            .user-name { display: none; }
            .profile-dropdown { width: 90%; right: 5%; }
            canvas { max-width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand"><i class="fas fa-wallet"></i> SmartExpense</div>
        <div class="nav-right">
            <div class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></div>
            <div class="user-profile" onclick="toggleProfileMenu()">
                <span class="user-name" id="nav-user-name">Guest</span>
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile" id="nav-profile-pic">
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
                <h3 style="border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:15px; font-size:1.1rem; font-weight:600;">Profile Settings</h3>
                <div class="dropdown-form">
                    <label>Profile Picture</label><input type="file" id="p-image-upload" accept="image/*">
                    <label>Full Name</label><input type="text" id="p-name" placeholder="Enter your name">
                    <label>Email</label><input type="email" id="p-email" placeholder="Enter your email">
                    <label>Phone</label><input type="text" id="p-phone" placeholder="Enter 10 digit number">
                    <label>Address</label><input type="text" id="p-address">
                    <div style="display:flex; gap:10px;">
                        <div style="width:50%"><label>Monthly Limit</label><input type="number" id="p-monthly"></div>
                        <div style="width:50%"><label>Daily Limit</label><input type="number" id="p-daily"></div>
                    </div>
                    <button class="save-btn" onclick="saveProfile()">Update Profile</button>
                    <button class="logout-btn" onclick="logout()">Logout & Reset</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" id="report-area">
        <div class="action-bar" data-html2canvas-ignore="true">
            <button class="action-btn btn-reset" onclick="resetData()"><i class="fas fa-trash"></i> Reset Data</button>
            <button class="action-btn btn-img" onclick="downloadImage()"><i class="fas fa-image"></i> Save Image</button>
            <button class="action-btn btn-pdf" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Save PDF</button>
        </div>

        <div class="balance-container">
            <div class="card"><h3>Balance</h3><h1 id="balance">$0</h1></div>
            <div class="card"><h3>Income</h3><h1 id="money-plus" class="money plus">+$0</h1></div>
            <div class="card"><h3>Expense</h3><h1 id="money-minus" class="money minus">-$0</h1></div>
        </div>

        <div class="limit-section">
            <div class="limit-info"><strong>Monthly Budget</strong><span id="limit-text">0%</span></div>
            <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span id="warning-msg" style="font-size:0.75rem; color:var(--expense-color); display:none;">⚠️ Limit Exceeded!</span>
                <span id="limit-display" style="font-size:0.75rem; color:var(--text-muted); margin-left:auto;">Limit: 50000</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="form-container" data-html2canvas-ignore="true">
                <h3 style="font-size:1rem; margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">New Transaction</h3>
                <form id="form">
                    <div class="form-control">
                        <label>Type</label>
                        <select id="type">
                            <option value="expense">Expense (-)</option>
                            <option value="income">Income (+)</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label>Category</label>
                        <select id="category">
                            <optgroup label="Expenses">
                                <option value="Food">Food & Dining</option>
                                <option value="Rent">Rent & Bills</option>
                                <option value="Transport">Transport</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Health">Health</option>
                            </optgroup>
                            <optgroup label="Income">
                                <option value="Salary">Salary</option>
                                <option value="Business">Business</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investment">Investment</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-control"><label>Description</label><input type="text" id="text" placeholder="Detail..."></div>
                    <div class="form-control"><label>Amount</label><input type="number" id="amount" placeholder="0.00"></div>
                    <div class="form-control"><label>Date</label><input type="date" id="date"></div>
                    <button class="btn">Add Record</button>
                </form>
            </div>

            <div class="right-column">
                <div class="charts-row">
                    <div class="chart-card"><h4>Income</h4><div class="canvas-wrapper"><canvas id="incomeChart"></canvas></div></div>
                    <div class="chart-card"><h4>Expenses</h4><div class="canvas-wrapper"><canvas id="expenseChart"></canvas></div></div>
                </div>

                <div class="history-list">
                    <h3 style="font-size:1rem; margin-bottom:10px;">Recent History</h3>
                    <ul id="list" class="list"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const balance = document.getElementById('balance');
        const money_plus = document.getElementById('money-plus');
        const money_minus = document.getElementById('money-minus');
        const list = document.getElementById('list');
        const form = document.getElementById('form');
        const text = document.getElementById('text');
        const amount = document.getElementById('amount');
        const type = document.getElementById('type');
        const category = document.getElementById('category');
        const dateInput = document.getElementById('date');
        const progressBar = document.getElementById('progress-bar');
        const limitText = document.getElementById('limit-text');
        const warningMsg = document.getElementById('warning-msg');
        const limitDisplay = document.getElementById('limit-display');
        const profileDropdown = document.getElementById('profile-dropdown');
        const navUserName = document.getElementById('nav-user-name');
        const navProfilePic = document.getElementById('nav-profile-pic');
        const inputs = {
            name: document.getElementById('p-name'), email: document.getElementById('p-email'),
            phone: document.getElementById('p-phone'), address: document.getElementById('p-address'),
            monthly: document.getElementById('p-monthly'), daily: document.getElementById('p-daily'),
            image: document.getElementById('p-image-upload')
        };

        // --- CUSTOM DELETE ICON (BASE64) ---
        const deleteIconBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAABACAIAAADJfoOfAAAAA3NCSVQICAjb4U/gAAAAp3pUWHRSYXcgcHJvZmlsZSB0eXBlIEFQUDEAABiVfU5BDsMwCLvnFX2CwZQ0z6mqdqo0bVP/fxhZMq29zChALANOt/WxHvsyvI7ntt/XNFSIebJiRWcAExoIiEJqjdzQKyU6jSb3v7bqZcqwk27GBWMonC453oeoWpS2x75nqRFANXPeteC39MT3sbAzW/Wknc/X0yCpLhRmV5qPzDSKB+2R3Ij/UZHe7ORA0iHuKs8AAAImSURBVGiB7Zo9S8NAGMfvkhJI6SQO4lAczCKu7eRg6+QuTi4ifgT7FQQrzp0c3VzcBPsyFIQWoa7WqaBYBJeGll5MzkHFF+zd097j2cj9tjYP+f+43D2XkNCe3ydxw/prgUkw0row0row0row0row0rpIjFUdVcq8VuXtNhkM8F1cl3oeXc1Z+TVxIYXeMDEWFg94s4EgJ4NmsvZegTjOqALo9NBmTAjhzUZYPBAUgKSjSlmb8Su82Ygq5VFHQdK8VsXzgSIIhUm323gyUAShsDn9G71CITSWfTqW0uNtLlDmN1KH23bq0z/dcn/3KEA6PZq0tVlMbS3R1x+2Q7/tDAvrybP3fS58CEo7/fPJs9CkE8tpyx25hxFC6MfRtL1EyDRIs9I+7a5/mRKjeGwNj5Wy8Ob0fYs72/ai3Dq62w/VojAX4rMzk1yYk1UxXlcNwmx5UcgAVYz4qkGofVrxqoNBle48cXnRU3SqmhPLHRFV+hIw0iEDXA0JqNL3Q7nQwI+Uc8z0IB0ubWe+r95jtI900HtWPgeu9K18pDF6Oa50i113hGuRhVcn6jHIDwHB4U7vYiUx+/M9Ku9UghuEFPwnl6hVh9yCqGBani6MtC5g0q77yxrjhYKkqefhuUARhMKkV3N4MlAEoSBpK79GM1k8Hzk0kxW8xIAuRHuvoM377fWFoGCsj1Ti9qJomvjHfXrKMNK6MNK6MNK6MNK6MNK6iKX0C452qmb7B7O0AAAAAElFTkSuQmCC";

        dateInput.valueAsDate = new Date();
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        const defaultProfile = { 
            name: "Guest", email: "", phone: "", address: "", 
            monthlyLimit: 50000, dailyLimit: 2000,
            profilePic: "https://cdn-icons-png.flaticon.com/512/149/149071.png"
        };
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || defaultProfile;
        let incChart, expChart;

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function toggleProfileMenu() { profileDropdown.classList.toggle('active'); }
        window.onclick = function(e) {
            if (!e.target.closest('.user-profile') && !e.target.closest('.profile-dropdown')) profileDropdown.classList.remove('active');
        }

        function loadData() {
            if(localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }
            inputs.name.value = userProfile.name === "Guest" ? "" : userProfile.name;
            inputs.email.value = userProfile.email || "";
            inputs.phone.value = userProfile.phone || "";
            inputs.address.value = userProfile.address || "";
            inputs.monthly.value = userProfile.monthlyLimit;
            inputs.daily.value = userProfile.dailyLimit;
            
            navUserName.innerText = userProfile.name.split(' ')[0];
            navProfilePic.src = userProfile.profilePic;
            limitDisplay.innerText = `Limit: ${userProfile.monthlyLimit}`;
            updateUI();
        }

        function saveProfile() {
            const newName = inputs.name.value || "Guest";
            const newMonthly = Number(inputs.monthly.value) || 50000;
            const file = inputs.image.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function() { updateProfileData(newName, newMonthly, reader.result); }
                reader.readAsDataURL(file);
            } else { updateProfileData(newName, newMonthly, userProfile.profilePic); }
        }

        function updateProfileData(name, monthly, picUrl) {
            userProfile = {
                name: name, email: inputs.email.value, phone: inputs.phone.value,
                address: inputs.address.value, monthlyLimit: monthly,
                dailyLimit: Number(inputs.daily.value) || 2000, profilePic: picUrl
            };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            loadData();
            profileDropdown.classList.remove('active');
            alert("Profile Updated Successfully!");
        }

        function logout() {
            if(confirm("Are you sure? This will reset your profile details.")) {
                localStorage.removeItem('userProfile'); location.reload();
            }
        }

        function addTransaction(e) {
            e.preventDefault();
            if(!text.value || !amount.value) return alert('Enter details');
            const t = {
                id: Math.floor(Math.random()*1e8),
                text: text.value,
                amount: type.value === 'expense' ? -Math.abs(amount.value) : Math.abs(amount.value),
                category: category.value, date: dateInput.value, type: type.value
            };
            transactions.push(t);
            updateUI();
            text.value = ''; amount.value = '';
        }

        function removeTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            updateUI();
        }

        function updateUI() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            list.innerHTML = '';
            transactions.forEach(t => {
                const li = document.createElement('li');
                li.className = t.amount < 0 ? 'minus' : 'plus';
                li.innerHTML = `
                    <div><b>${t.text}</b> <span style="font-size:0.75rem; color:var(--text-muted)">${t.date}</span></div>
                    <div>${t.amount < 0 ? '-' : '+'}${Math.abs(t.amount)} 
                    <button class="delete-btn" onclick="removeTransaction(${t.id})">
                        <img src="${deleteIconBase64}" alt="Del">
                    </button></div>`;
                list.prepend(li);
            });

            const amounts = transactions.map(t => t.amount);
            const total = amounts.reduce((acc, i) => acc += i, 0);
            const inc = amounts.filter(i => i > 0).reduce((acc, i) => acc += i, 0);
            const exp = amounts.filter(i => i < 0).reduce((acc, i) => acc += i, 0) * -1;

            balance.innerText = `$${total.toFixed(2)}`;
            money_plus.innerText = `+$${inc.toFixed(2)}`;
            money_minus.innerText = `-$${exp.toFixed(2)}`;

            const pct = Math.min((exp / userProfile.monthlyLimit) * 100, 100);
            progressBar.style.width = `${pct}%`;
            limitText.innerText = `${pct.toFixed(1)}%`;
            progressBar.style.background = pct > 90 ? 'var(--expense-color)' : pct > 60 ? '#f59e0b' : 'var(--income-color)';
            warningMsg.style.display = pct > 90 ? 'inline' : 'none';

            renderCharts();
        }

        function renderCharts() {
            const getCatData = (type) => {
                const data = {};
                transactions.filter(t => t.type === type).forEach(t => {
                    data[t.category] = (data[t.category] || 0) + Math.abs(t.amount);
                });
                return data;
            };
            const cfg = (data, colors) => ({
                type: 'doughnut',
                data: {
                    labels: Object.keys(data).length ? Object.keys(data) : ['Empty'],
                    datasets: [{ data: Object.values(data).length ? Object.values(data) : [1], backgroundColor: colors, borderWidth: 0 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    layout: { padding: { bottom: 15 } },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 }, padding: 15 } } } 
                }
            });
            if(expChart) expChart.destroy();
            expChart = new Chart(document.getElementById('expenseChart'), cfg(getCatData('expense'), ['#ef4444', '#f97316', '#f59e0b', '#dc2626']));
            if(incChart) incChart.destroy();
            incChart = new Chart(document.getElementById('incomeChart'), cfg(getCatData('income'), ['#10b981', '#3b82f6', '#8b5cf6', '#06b6d4']));
        }

        function resetData() {
            if(confirm("Reset all transactions?")) { localStorage.removeItem('transactions'); transactions=[]; updateUI(); }
        }
        function downloadImage() { html2canvas(document.getElementById('report-area')).then(c => { const a = document.createElement('a'); a.download = 'report.png'; a.href = c.toDataURL(); a.click(); }); }
        function downloadPDF() { const { jsPDF } = window.jspdf; html2canvas(document.getElementById('report-area')).then(c => { const pdf = new jsPDF('p', 'mm', 'a4'); pdf.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, 210, (c.height * 210) / c.width); pdf.save('report.pdf'); }); }

        form.addEventListener('submit', addTransaction);
        loadData();
    </script>
</body>
</html>